# Каталог книг на Yii2

Тестовое задание - небольшой каталог книг с использованием Yii2 и MySQL.

## Требования

- Docker
- Docker Compose

## Установка и запуск

### 1. Клонируйте репозиторий

```bash
git clone <repository-url>
cd test_task_yii2
```

### 2. Настройте права доступа (ВАЖНО для корректной работы с файлами)

```bash
./setup-permissions.sh
```

Этот скрипт создаст `docker.env` с UID/GID текущего пользователя.

**Альтернативный вариант (ручная настройка):**
```bash
cp docker.env.example docker.env
# Отредактируйте USER_ID и GROUP_ID на значения из команд:
id -u  # ваш USER_ID
id -g  # ваш GROUP_ID
```

### 3. Запустите Docker-контейнеры

```bash
docker-compose up -d --build
```

### 4. Проверьте работу

Откройте в браузере: **http://localhost:8080**

## Данные для входа

- **Логин:** admin
- **Пароль:** admin123

## Функциональность

### Для всех пользователей (неавторизованных):
- ✅ Просмотр каталога книг
- ✅ Просмотр авторов
- ✅ Просмотр отчёта по авторам за год
- ✅ Подписка на SMS-уведомления о новых книгах

### Для авторизованных пользователей:
- ✅ Все возможности гостя +
- ✅ Создание книг с загрузкой обложек
- ✅ Редактирование книг
- ✅ Удаление книг
- ✅ Создание/редактирование/удаление авторов

## Структура проекта

```
test_task_yii2/
├── controllers/          # Контроллеры
│   ├── AuthorController  # CRUD авторов
│   ├── BookController    # CRUD книг
│   ├── ReportController  # Отчёты
│   └── SiteController    # Главная, подписка
├── models/               # Модели
│   ├── User.php          # Пользователь
│   ├── Author.php        # Автор
│   ├── Book.php          # Книга
│   └── Subscription.php  # Подписка
├── migrations/           # Миграции БД
├── views/                # Представления
│   ├── author/           # Страницы авторов
│   ├── book/             # Страницы книг
│   ├── report/           # Отчёты
│   └── site/             # Главная и подписка
├── web/uploads/          # Загруженные обложки книг
└── docker/               # Docker-конфигурация
```

## Полезные команды

### Docker

```bash
# Остановить контейнеры
docker-compose down

# Перезапустить
docker-compose restart

# Просмотр логов
docker-compose logs -f

# Войти в контейнер PHP
docker-compose exec php sh
```

### Yii2 Console

```bash
# Выполнить миграции
docker-compose exec php php yii migrate

# Откатить миграцию
docker-compose exec php php yii migrate/down

# Создать новую миграцию
docker-compose exec php php yii migrate/create <name>
```

## Основные страницы

- **Главная:** http://localhost:8080
- **Книги:** http://localhost:8080/book/index
- **Авторы:** http://localhost:8080/author/index
- **Отчёт:** http://localhost:8080/report/top-authors
- **Подписка:** http://localhost:8080/site/subscribe
- **Вход:** http://localhost:8080/site/login

## Технические детали

### База данных

- **Хост:** localhost (из хоста) или mysql (внутри контейнера)
- **Порт:** 3306
- **База данных:** yii2_books
- **Пользователь:** yii2_user
- **Пароль:** yii2_password

### Порты

- **8080** - Веб-интерфейс (nginx)
- **3306** - MySQL

### Структура БД

- **user** - пользователи системы
- **author** - авторы книг (ФИО)
- **book** - книги (название, год, описание, ISBN, обложка)
- **book_author** - связь many-to-many между книгами и авторами
- **subscription** - подписки на SMS-уведомления

## Права доступа

Проект настроен для работы с правами вашего локального пользователя:
- Все файлы, создаваемые в контейнере, будут иметь ваши UID/GID
- Вы сможете свободно редактировать файлы на хосте без проблем с правами
- При переносе на другой компьютер просто запустите `./setup-permissions.sh`

**Важно**: Файл `docker.env` содержит ваши USER_ID и GROUP_ID. 
При клонировании проекта на другой компьютер обязательно запустите `./setup-permissions.sh` заново!

## SMS-уведомления

При создании новой книги система отправляет SMS-уведомления всем подписчикам.
В текущей версии используется эмулятор (логирование в файл).

Для интеграции с реальным SMS-сервисом (smspilot.ru):
1. Зарегистрируйтесь на smspilot.ru
2. Получите API-ключ
3. Обновите метод `sendNotifications()` в модели `Book`

## Отчёт "Топ-10 авторов"

Показывает список 10 авторов, выпустивших наибольшее количество книг за указанный год.
Год можно выбрать через форму на странице отчёта.

## Тестовые данные

В проекте уже добавлены:
- 1 пользователь: admin/admin123
- 10 авторов русской классики
- 10 книг (некоторые за 2024-2025 года для демонстрации отчёта)

## Разработка

### Добавление новых миграций

```bash
docker-compose exec php php yii migrate/create <migration_name>
```

### Работа с Gii (генератор кода)

Gii доступен по адресу: http://localhost:8080/gii

## Лицензия

MIT

## Автор

Разработано в рамках тестового задания
